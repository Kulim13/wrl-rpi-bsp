From c8e09a503b118c9927130bdd955df9fc09e6e97b Mon Sep 17 00:00:00 2001
From: popcornmix <popcornmix@gmail.com>
Date: Wed, 27 Apr 2016 17:43:28 +0100
Subject: [PATCH 001/212] Revert "SUNRPC: Make NFS swap work with multipath"

This reverts commit 15001e5a7e1e207b6bd258cd8f187814cd15b6dc.
---
 net/sunrpc/clnt.c | 66 +++++++++++++++++++++++++++++++++++--------------------
 1 file changed, 42 insertions(+), 24 deletions(-)

diff --git a/net/sunrpc/clnt.c b/net/sunrpc/clnt.c
index 4acf827..e22665f 100644
--- a/net/sunrpc/clnt.c
+++ b/net/sunrpc/clnt.c
@@ -2748,39 +2748,57 @@ void rpc_show_tasks(struct net *net)
 #endif
 
 #if IS_ENABLED(CONFIG_SUNRPC_SWAP)
-static int
-rpc_clnt_swap_activate_callback(struct rpc_clnt *clnt,
-		struct rpc_xprt *xprt,
-		void *dummy)
-{
-	return xprt_enable_swap(xprt);
-}
-
 int
 rpc_clnt_swap_activate(struct rpc_clnt *clnt)
 {
-	if (atomic_inc_return(&clnt->cl_swapper) == 1)
-		return rpc_clnt_iterate_for_each_xprt(clnt,
-				rpc_clnt_swap_activate_callback, NULL);
-	return 0;
-}
-EXPORT_SYMBOL_GPL(rpc_clnt_swap_activate);
+	int ret = 0;
+	struct rpc_xprt	*xprt;
 
-static int
-rpc_clnt_swap_deactivate_callback(struct rpc_clnt *clnt,
-		struct rpc_xprt *xprt,
-		void *dummy)
-{
-	xprt_disable_swap(xprt);
-	return 0;
+	if (atomic_inc_return(&clnt->cl_swapper) == 1) {
+retry:
+		rcu_read_lock();
+		xprt = xprt_get(rcu_dereference(clnt->cl_xprt));
+		rcu_read_unlock();
+		if (!xprt) {
+			/*
+			 * If we didn't get a reference, then we likely are
+			 * racing with a migration event. Wait for a grace
+			 * period and try again.
+			 */
+			synchronize_rcu();
+			goto retry;
+		}
+
+		ret = xprt_enable_swap(xprt);
+		xprt_put(xprt);
+	}
+	return ret;
 }
+EXPORT_SYMBOL_GPL(rpc_clnt_swap_activate);
 
 void
 rpc_clnt_swap_deactivate(struct rpc_clnt *clnt)
 {
-	if (atomic_dec_if_positive(&clnt->cl_swapper) == 0)
-		rpc_clnt_iterate_for_each_xprt(clnt,
-				rpc_clnt_swap_deactivate_callback, NULL);
+	struct rpc_xprt	*xprt;
+
+	if (atomic_dec_if_positive(&clnt->cl_swapper) == 0) {
+retry:
+		rcu_read_lock();
+		xprt = xprt_get(rcu_dereference(clnt->cl_xprt));
+		rcu_read_unlock();
+		if (!xprt) {
+			/*
+			 * If we didn't get a reference, then we likely are
+			 * racing with a migration event. Wait for a grace
+			 * period and try again.
+			 */
+			synchronize_rcu();
+			goto retry;
+		}
+
+		xprt_disable_swap(xprt);
+		xprt_put(xprt);
+	}
 }
 EXPORT_SYMBOL_GPL(rpc_clnt_swap_deactivate);
 #endif /* CONFIG_SUNRPC_SWAP */
-- 
1.9.1

